<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Profile | FileShare Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .card:hover {
      box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.3s ease-in-out;
    }
    .btn-group > .btn i {
      margin-right: 4px;
    }
    .blur {
    filter: blur(5px);
    pointer-events: none;
    user-select: none;
    }
  </style>
</head>
<body class="bg-light">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="{% url 'home' %}">FileShare Hub</a>
    <div class="d-flex align-items-center">
      {% if user.is_authenticated %}
      <span class="me-3 fw-bold text-white">Welcome, {{ user.username }}</span>
      <form method="post" action="{% url 'logout' %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger btn-sm">Logout</button>
      </form>
      {% endif %}
    </div>
  </div>
</nav>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title">Account Deletion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeModal"></button>
      </div>
      <div class="modal-body">
        <div id="otp-confirmation-step">
            <p>The OTP will be sent to <strong>{{ user.email }}</strong></p>
          <button class="btn btn-danger w-100" id="sendOtpBtn">Yes, Send OTP</button>
        </div>
        <div id="otp-step" style="display:none;">
          <input type="text" id="otpInput" class="form-control mb-3" placeholder="Enter 6-digit OTP">
          <div id="otp-error" class="text-danger mb-2" style="display:none;"></div>
          <button class="btn btn-primary w-100" id="verifyOtpBtn">Verify & Delete Account</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% comment %}  edit profile modal {% endcomment %}
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title">Edit Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editProfileForm">
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input type="text" class="form-control" id="editUsername" value="{{ user.username }}" disabled>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="editEmail" value="{{ user.email }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Phone Number</label>
            <input type="text" class="form-control" id="editPhone" value="{{ profile.phone_number }}">
          </div>
          <div class="mb-3">
            <label class="form-label">Bio</label>
            <textarea class="form-control" id="editBio">{{ profile.bio }}</textarea>
          </div>
          <button type="submit" class="btn btn-success w-100">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="container mt-5">
  <div class="row g-4">
    <!-- Your Profile -->
    <div class="col-lg-3 col-md-6">
      <div class="card shadow-sm rounded">
        <div class="card-header bg-primary text-white">Your Profile</div>
        <div class="card-body p-4">
          <p><strong>Username:</strong> {{ user.username }}</p>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p><strong>Phone Number:</strong> {{ profile.phone_number }}</p>
          <p><strong>Bio:</strong> {{ profile.bio }}</p>
          {% if profile.profile_picture %}
          <img src="{{ profile.profile_picture.url }}" class="img-thumbnail mb-3" height="100" width="100" alt="Profile Picture">
          {% endif %}
<div class="text-center mt-4">
  <div class="d-inline-flex gap-2">
    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editProfileModal">
      <i class="bi bi-pencil-square me-1"></i> Edit Profile
    </button>
    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
      <i class="bi bi-trash3 me-1"></i> Delete Account
    </button>
  </div>
</div>



        </div>
      </div>
    </div>

    <!-- Other Users -->
    {% if other_users %}
    <div class="col-lg-3 col-md-6">
      <div class="card shadow-sm rounded">
        <div class="card-header bg-info text-white">Other Users</div>
        <div class="card-body p-4">
          <div class="input-group w-100 mb-3">
            <input type="text" id="userSearch" class="form-control" placeholder="Search users...">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
          </div>
          <div class="table-responsive">
            <table id="otherUsersTable" class="table table-striped table-bordered">
              <thead class="table-light"><tr><th>Username</th><th>Action</th></tr></thead>
              <tbody>
                {% for u in other_users %}
                <tr data-search-text="{{ u.username|lower }}">
                  <td>
                    {% if u.profile.profile_picture %}
                    <img src="{{ u.profile.profile_picture.url }}" class="rounded-circle me-2" width="30" height="30" alt="User">
                    {% endif %}
                    {{ u.username }}
                  </td>
                  <td>
                    {% if u.id in sent_requests %}
                    <button class="btn btn-sm btn-secondary follow-btn" data-user-id="{{ u.id }}" data-sent="true">
                      <i class="bi bi-hourglass-split"></i> Request Sent
                    </button>
                    {% else %}
                    <button class="btn btn-sm btn-outline-primary follow-btn" data-user-id="{{ u.id }}" data-sent="false">
                      <i class="bi bi-person-plus"></i> Follow
                    </button>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Friends -->
    <div class="col-lg-3 col-md-6" {% if not friends %}style="display: none;"{% endif %}>
      <div class="card shadow-sm rounded" id="friends-section">
        <div class="card-header bg-success text-white">Friends</div>
        <div class="card-body p-4">
          <div class="input-group w-100 mb-3">
            <input type="text" id="friendSearch" class="form-control" placeholder="Search friends...">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead class="table-light"><tr><th>Username</th><th>Actions</th></tr></thead>
              <tbody id="friends-list">
                {% for friend in friends %}
                <tr data-user-id="{{ friend.id }}" data-search-text="{{ friend.username|lower }}">
                  <td>
                    {% if friend.profile.profile_picture %}
                    <img src="{{ friend.profile.profile_picture.url }}" class="rounded-circle me-2" width="30" height="30" alt="User">
                    {% endif %}
                    {{ friend.username }}
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group" aria-label="Files and Unfriend">
  <a href="{% url 'view_user_files' user_id=friend.id %}" class="btn btn-outline-secondary d-flex align-items-center">
    <i class="bi bi-folder2-open me-1"></i> Files
  </a>
  <button type="button" class="btn btn-danger unfriend-btn d-flex align-items-center" data-user-id="{{ friend.id }}">
    <i class="bi bi-person-dash me-1"></i> Unfriend
  </button>
</div>

                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Follow Requests -->
    {% if follow_requests %}
    <div class="col-lg-3 col-md-6">
      <div class="card shadow-sm rounded" id="follow-requests-section">
        <div class="card-header bg-warning text-dark">Follow Requests Received</div>
        <div class="card-body p-4">
          <div class="input-group w-100 mb-3">
            <input type="text" id="requestSearch" class="form-control" placeholder="Search requests...">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead class="table-light"><tr><th>Username</th><th>Action</th></tr></thead>
              <tbody id="request-list">
                {% for req in follow_requests %}
                <tr data-request-id="{{ req.id }}" data-user-id="{{ req.from_user.id }}" data-search-text="{{ req.from_user.username|lower }}">
                  <td>
                    {% if req.from_user.profile.profile_picture %}
                    <img src="{{ req.from_user.profile.profile_picture.url }}" class="rounded-circle me-2" width="30" height="30" alt="User">
                    {% endif %}
                    {{ req.from_user.username }}
                  </td>
                  <td>
                    <button class="btn btn-sm btn-success accept-btn" data-request-id="{{ req.id }}">
                      <i class="bi bi-check-lg"></i> Accept
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const csrftoken = getCookie("csrftoken");

    // ✅ EDIT PROFILE SECTION
    const editForm = document.getElementById('editProfileForm');
    if (editForm) {
        editForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const email = document.getElementById('editEmail').value;
            const phone = document.getElementById('editPhone').value;
            const bio = document.getElementById('editBio').value;

            fetch("{% url 'edit_profile_api' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    phone_number: phone,
                    bio: bio
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Profile updated successfully!");
                    location.reload();
                } else {
                    alert("Failed to update profile!");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Something went wrong!");
            });
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function followHandler(event) {
        const btn = event.target.closest("button");
        const userId = btn.dataset.userId;
        const isSent = btn.dataset.sent === "true";
        const url = isSent ? `/api/users/undo-follow/${userId}/` : `/api/users/follow/${userId}/`;

        fetch(url, {
            method: "POST",
            headers: { "X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest" },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "ok") {
                btn.innerHTML = isSent
                    ? `<i class="bi bi-person-plus"></i> Follow`
                    : `<i class="bi bi-hourglass-split"></i> Request Sent`;
                btn.classList.toggle("btn-secondary");
                btn.classList.toggle("btn-outline-primary");
                btn.dataset.sent = (!isSent).toString();
            }
        });
    }

    function unfriendHandler(event) {
        const btn = event.target.closest("button");
        const userId = btn.dataset.userId;
        const row = btn.closest("tr");

        fetch(`/api/users/unfriend/${userId}/`, {
            method: "POST",
            headers: { "X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest" },
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "ok") {
                row.remove();
                const otherUsersTable = document.querySelector("#otherUsersTable tbody");
                if (otherUsersTable) {
                    const newRow = document.createElement("tr");
                    newRow.dataset.searchText = data.username.toLowerCase();
                    newRow.innerHTML = `
                        <td>${data.username}</td>
                        <td>
                        <button class="btn btn-sm btn-outline-primary follow-btn" data-user-id="${userId}" data-sent="false">
                              <i class="bi bi-person-plus"></i> Follow
                        </button>
                        </td>
                    `;
                    otherUsersTable.appendChild(newRow);
                    newRow.querySelector(".follow-btn").addEventListener("click", followHandler);
                }
            }
        });
    }

function acceptFollowHandler(button) {
    const requestId = button.dataset.requestId;
    const trEl = button.closest("tr");
    const userId = trEl.dataset.userId;
    const username = trEl.querySelector("td").innerText;
    const userCellHtml = trEl.querySelector("td").innerHTML;

    fetch(`/accept-follow-request/${requestId}/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest" },
    })
    .then(res => res.json())
    .then(data => {
        if (data.success && data.follow_back) {
            const followBackBtn = document.createElement("button");
            followBackBtn.className = "btn btn-sm btn-outline-primary follow-back-btn";
            followBackBtn.innerHTML = `<i class="bi bi-person-plus"></i> Follow Back`;
            followBackBtn.dataset.userId = userId;

            // On follow-back click
            followBackBtn.addEventListener("click", function () {
                fetch(`/accept-follow/${userId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrftoken,
                        "X-Requested-With": "XMLHttpRequest",
                    },
                })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        trEl.remove(); // Remove from follow requests
                        const requestList = document.getElementById("request-list");
                        if (requestList.querySelectorAll("tr").length === 0) {
                          document.getElementById("follow-requests-section").style.display = "none";
                        }
                        // Show friends section
                        const friendsSection = document.getElementById("friends-section");
                        friendsSection.classList.remove("d-none");
                        friendsSection.style.display = "";
                        // ✅ Find the parent column wrapper and unhide it
                        const friendsColumn = friendsSection.closest(".col-lg-3");
                        if (friendsColumn && friendsColumn.style.display === "none") {
                            friendsColumn.style.display = "block";
                        }

                        // Add to friends table
                        const friendsList = document.getElementById("friends-list");
                        const newRow = document.createElement("tr");
                        newRow.dataset.userId = userId;
                        newRow.dataset.searchText = username.toLowerCase();
                        newRow.innerHTML = `
<td>${userCellHtml}</td>
<td>
  <div class="btn-group btn-group-sm" role="group" aria-label="Files and Unfriend">
    <a href="/users/${userId}/files/" class="btn btn-outline-secondary d-flex align-items-center">
      <i class="bi bi-folder2-open me-1"></i> Files
    </a>
    <button type="button" class="btn btn-danger unfriend-btn d-flex align-items-center" data-user-id="${userId}">
      <i class="bi bi-person-dash me-1"></i> Unfriend
    </button>
  </div>
</td>
`;

                        friendsList.appendChild(newRow);

                        // Attach unfriend handler
                        newRow.querySelector(".unfriend-btn").addEventListener("click", unfriendHandler);
                    }
                });
            });

            button.replaceWith(followBackBtn);
        }
    });
}

    document.querySelectorAll(".follow-btn").forEach(btn => btn.addEventListener("click", followHandler));
    document.querySelectorAll(".unfriend-btn").forEach(btn => btn.addEventListener("click", unfriendHandler));
    document.querySelectorAll(".accept-btn").forEach(btn => btn.addEventListener("click", function () { acceptFollowHandler(btn); }));

    // ✅ DELETE ACCOUNT OTP SECTION
    const modal = document.getElementById('deleteAccountModal');
    const profileContainer = document.querySelector('.container');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const otpStep = document.getElementById('otp-step');
    const otpConfirmation = document.getElementById('otp-confirmation-step');
    const otpInput = document.getElementById('otpInput');
    const otpError = document.getElementById('otp-error');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');

    modal.addEventListener('show.bs.modal', function () {
        profileContainer.classList.add('blur');
        otpConfirmation.style.display = 'block';
        otpStep.style.display = 'none';
        otpError.style.display = 'none';
        otpInput.value = '';
    });

    modal.addEventListener('hidden.bs.modal', function () {
        profileContainer.classList.remove('blur');
    });

    sendOtpBtn.addEventListener('click', function () {
        fetch("{% url 'request_delete_account' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie("csrftoken"),
                'Content-Type': 'application/json',
            }
        })
        .then(res => res.json())
        .then(data => {
            otpConfirmation.style.display = 'none';
            otpStep.style.display = 'block';
        });
    });

    verifyOtpBtn.addEventListener('click', function () {
        const otp = otpInput.value.trim();
        otpError.style.display = 'none';
        fetch("{% url 'verify_delete_otp' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie("csrftoken"),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ otp: otp }),
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                otpError.innerText = data.error;
                otpError.style.display = 'block';
            } else if (data.success) {
                alert("Account deleted successfully!");
                window.location.href = "{% url 'home' %}";
            }
        });
    });

    function attachSearch(inputId, rowsSelector) {
        const input = document.getElementById(inputId);
        const rows = document.querySelectorAll(rowsSelector);
        input?.addEventListener("input", function () {
            const query = this.value.trim().toLowerCase();
            rows.forEach(row => {
                const searchText = row.dataset.searchText;
                row.style.display = searchText.includes(query) ? "" : "none";
            });
        });
    }

    attachSearch("userSearch", "#otherUsersTable tbody tr");
    attachSearch("friendSearch", "#friends-list tr");
    attachSearch("requestSearch", "#request-list tr");
});
</script>

</body>
</html>
